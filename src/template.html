<!DOCTYPE html>
<html>
<head>
  <title>Test</title>
  <style>
    body {
      padding: 20px;
    }

    .console {
      margin: 16px 0;
    }

    .console pre {
      display: flex;
      flex-direction: column;
      gap: 5px;
      resize: vertical;
      height: 100px;
      min-height: 100px;

      overflow: scroll;
      overscroll-behavior-y: contain;
      scroll-snap-type: y mandatory;
    }

    .console pre > div.error {
      color: rgb(234, 46, 46);
    }

    .console.stick-to-bottom pre > div:last-child {
      scroll-snap-align: start;
    }

    .exec-button, .clear-button {
      width: 65px;
    }
  </style>
  <style id="code-style"></style>
  <style id="md-style"></style>
</head>
<body class="markdown-body">
  <script src="/socket.io/socket.io.js"></script>
  <div id="content"></div>
  <script>
    const socket = new io()

    setInterval(() => {
      if (!socket.connected) {
        console.log("trying to connect...")
        socket.connect()
      }
    }, 5000)

    const mapping = {}

    const elements = Array.from(document.getElementsByClassName("backend-code-exec-wrapper"))
    elements.forEach(element => {
      const { id } = element
      const consoleElement = document.getElementById(`${id}-console`)

      mapping[id] = {
        id,
        consoleElement
      }

      socket.on(`${id}-data`, data => {
        consoleElement.innerHTML += data.split("\n").map(data => `<div class="data">${data}</div>`).join("")
      })

      socket.on(`${id}-error`, data => {
        consoleElement.innerHTML += data.split("\n").map(data => `<div class="error">${data}</div>`).join("")
      })

      socket.on(`${id}-end`, data => {
        const button = document.getElementById(`${id}-exec-button`)

        if (button.innerHTML !== "run") {
          button.innerHTML = "run"
        }
      })
    })

    function clearConsole(id) {
      mapping[id].consoleElement.innerHTML = ""
    }

    function exec(id, language) {
      const button = document.getElementById(`${id}-exec-button`)
      if (button.innerHTML === "run") {
        clearConsole(id)
        socket.emit("exec", id)
        button.innerHTML = "stop"
      } else {
        socket.emit("kill", id)
        button.innerHTML = "run"
      }
    }

    function onScroll(e) {
      const element = e.target
      if (element.offsetHeight + element.scrollTop >= element.scrollHeight - 5) {
        element.parentElement.classList.add("stick-to-bottom")
      } else {
        element.parentElement.classList.remove("stick-to-bottom")
      }
    }
  </script>
</body>
</html>
